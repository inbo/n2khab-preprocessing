# Making the data source

We will create a 'raw' data source `habitatquarries` by cleaning a precursor dataset.

```{r}
local_root <- find_root(has_file("generate_habitatquarries.Rproj"))
datapath <- file.path(local_root, "data")
if (!dir.exists(datapath)) dir.create(datapath)
```


## Load draft dataset

_This code is no longer executed because of the manual steps undertaken afterwards._
_Go directly to [manual updates](#manual-updates)._

```{r eval=FALSE}
drive_auth(email = TRUE)
drive_ls(as_id("1tJLjAlVbcNHcP4bgp7zRLS9e0KB9vyMs")) %>% 
  {map2(.$name, .$id, function(name, id) {
    drive_download(as_id(id),
               path = file.path(tempdir(), name),
               overwrite = TRUE)
  })} %>% 
  invisible()
```


```{r paged.print = FALSE, eval=FALSE}
habitatquarries <- read_sf(file.path(tempdir(), "8310_v2018_RAPHAB2019.shp"),
                        crs = 31370)
```

```{r paged.print = FALSE, eval=FALSE}
habitatquarries
```

## First standardization steps

_This code is no longer executed because of the manual steps undertaken afterwards._
_Go directly to [manual updates](#manual-updates)._

From common values of variables `id_old1` and `id_old2` in the below standardized dataset, we will derive a `unit_id` variable that represents somehow interconnected systems:

```{r paged.print = FALSE, eval=FALSE}
(habitatquarries <- 
   habitatquarries %>% 
   select(id_old1 = Id, 
          id_old2 = nr,
          name = Naam,
          type = HT8310,
          source = Bron))
```

Writing a derived dataset that contains the auto-generated `unit_id`:

```{r eval=FALSE}
habitatquarries %>% 
  st_drop_geometry %>% 
  count(id_old1, id_old2) %>% 
  filter(n > 1, id_old1 > 0 | id_old2 > 0) %>% 
  mutate(unit_id = 1:nrow(.)) %>% 
  select(-n) %>% 
  right_join(habitatquarries, by = c("id_old1", "id_old2")) %>% 
  select(-contains("old")) %>% 
  st_write(file.path(datapath,
                     "habitatquarries1.gpkg"),
           delete_dsn = TRUE)
```

## Manual updates

At this stage, `habitatquarries1.gpkg` has been copied to `habitatquarries2.gpkg` which was subsequently edited in **QGIS** 3.14:

- updated a truncated value for `source`;
- capitalized a lowercase name in `source`;
- added a few extra `unit_id` values for adjacent polygons and interconnected quarries;
- deleted 2 rows without geometry;
- updated the value of `type` for one polygon;
- updated the value of `name` for many polygons;
- updated the value of `source` for many polygons.

```{r eval=FALSE}
# Saving/updating the manually crafted habitatquarries2.gpkg in Google Drive:
drive_update(media = file.path(datapath, "habitatquarries2.gpkg"),
             file = as_id("1aM3hZqEp3ax66PCrhuyjwBZKd3EcALUS"))
```

## Final standardization and writing the resulting data source

Reading `habitatquarries2.gpkg` and turning it into a standardized data source:

```{r paged.print = FALSE}
drive_download(as_id("1aM3hZqEp3ax66PCrhuyjwBZKd3EcALUS"),
               path = file.path(tempdir(), "habitatquarries2.gpkg"),
               overwrite = TRUE)
habitatquarries <- read_sf(file.path(tempdir(), "habitatquarries2.gpkg")) 
# for spatial sorting:
centr <- 
  st_centroid(habitatquarries) %>% 
  st_coordinates()
habitatquarries %>% 
  mutate(x = centr[,"X"],
         y = centr[,"Y"]) %>% 
  arrange(unit_id, x, y) %>% 
  mutate(polygon_id = 1:nrow(.),
         unit_id = ifelse(is.na(unit_id),
                          100 + polygon_id,
                          unit_id) %>% 
                    as.integer,
         code_orig = ifelse(str_detect(type, "WAL|NL"),
                            NA_character_,
                            type),
         is_habitat = case_when(
           str_detect(type, "WAL|NL") ~ NA,
           str_detect(type, "8310") ~ TRUE,
           TRUE ~ FALSE
         ),
         type = ifelse(str_detect(type, "8310") & 
                         !str_detect(type, "WAL|NL"), 
                       "8310", 
                       NA_character_),
         source = ifelse(source == "", NA, source)) %>% 
  select(polygon_id,
         unit_id,
         name,
         code_orig,
         type,
         is_habitat,
         extra_reference = source) %>% 
  st_write(file.path(datapath, "habitatquarries.gpkg"),
           delete_dsn = TRUE)
```

# Adding the bibliography

The literature references have been saved as a BibTeX bibliography file `habitatquarries.bib`, making it usable by most reference management software and R Markdown.

We will include this information as a table inside the GeoPackage, in order to make the latter self-contained, but we'll do that in a way that it can be read out to a BibTeX file.

## Creating a dataframe from the BibTeX bibliography file

```{r warning=FALSE}
refs <- bib2df(file.path(datapath, "habitatquarries.bib"))
```


```{r}
refs2 <-
  refs %>% 
  map_lgl(function(col) any(!is.na(col))) %>% 
  refs[,.] %>% 
  `colnames<-`(tolower(colnames(.))) %>% 
  mutate(author = map_chr(author, 
                          function(x) paste(x, collapse = " and ")))
```


```{r}
glimpse(refs2)
```

Suggestion for making a function to read back as BibTeX bibliography:

```{r eval=FALSE}
refs2 %>% 
  mutate(author = str_split(author, " and ")) %>% 
  `colnames<-`(toupper(colnames(.))) %>%
  df2bib
```

## Adding the dataframe to the GeoPackage

```{r}
refs2 %>% 
  st_write(file.path(datapath, "habitatquarries.gpkg"),
           layer = "extra_references",
           delete_layer = TRUE)
```



# Checks on the data source

Checksums:

```{r}
filepath <- file.path(datapath, "habitatquarries.gpkg")
openssl::md5(filepath) %>% str_c(collapse = '') %>% `names<-`("md5sum")
openssl::sha256(filepath) %>% str_c(collapse = '') %>% `names<-`("sha256sum")
```


Available layers:

```{r paged.print = FALSE}
st_layers(filepath)
```

## Geospatial layer

Reading from file:

```{r paged.print = FALSE}
habitatquarries_test <- 
  read_sf(filepath,
          layer = "habitatquarries")
```

Overview of contents:

```{r paged.print = FALSE}
habitatquarries_test %>% 
  print(n = Inf)
```

All attributes:

```{r}
habitatquarries_test %>% 
  st_drop_geometry
```
Number of unique combinations of `unit_id` and `name`:

```{r}
habitatquarries_test %>% 
  st_drop_geometry %>% 
  count(unit_id, name) %>% 
  kable
```

Number of unique combinations of `type` and `is_habitat`:

```{r}
habitatquarries_test %>% 
  st_drop_geometry %>% 
  count(type, is_habitat)
```
Zooming in on non-TRUE cases of `is_habitat` shows that this coincides with two possible values of `code_orig`:

```{r}
habitatquarries_test %>% 
  st_drop_geometry %>% 
  filter(!is_habitat | is.na(is_habitat)) %>% 
  count(code_orig, type, is_habitat)
```

Hence, when `is_habitat = FALSE` we know that no habitat is present.
When unknown (outside of Flanders), it is set as `NA`.

Occurrence of different references:

```{r paged.print = FALSE}
habitatquarries_test %>% 
  st_drop_geometry %>% 
  count(extra_reference)
```

```{r warning=FALSE}
provinces_path <- find_root_file("n2khab_data/10_raw/provinces",
                                 criterion = has_dir("n2khab_data"))
provinces <- 
  read_sf(provinces_path, crs = 31370)
bbox1 <- st_bbox(habitatquarries_test)
```

Overview map:

```{r}
ggplot() +
  geom_sf(data = provinces, fill = "white", colour = "grey70") +
  geom_sf(data = habitatquarries_test,
          colour = NA,
          aes(fill = factor(unit_id))) + 
  coord_sf(datum = st_crs(31370),
           xlim = bbox1$xlim + c(-2e3, 2e3), 
           ylim = bbox1$ylim + c(-2e3, 2e3)) +
  theme_bw() +
  theme(legend.position = "none")
```

Zoomed in on the eastern part:

```{r}
zoom <- coord_sf(datum = st_crs(31370),
                 xlim = c(234e3, 244e3), 
                 ylim = c(163e3, 169.2e3))
ggplot() +
  geom_sf(data = provinces, fill = "white", colour = "grey70") +
  geom_sf(data = habitatquarries_test,
          colour = NA,
          aes(fill = factor(unit_id))) + 
  zoom +
  geom_sf_text(data = habitatquarries_test,
               aes(label = unit_id),
               size = 3) +
  theme_bw() +
  theme(legend.position = "none",
        axis.title = element_blank())
```

With the combined values shown of `code_orig`, `is_habitat` and `type`:

```{r}
ggplot() +
  geom_sf(data = provinces, fill = "white", colour = "grey70") +
  geom_sf(data = 
            habitatquarries_test %>% 
            mutate(`code_orig:is_habitat:type` = paste(code_orig, 
                                                       is_habitat, 
                                                       type, 
                                                       sep = ":")),
          colour = NA,
          aes(fill = `code_orig:is_habitat:type`)) + 
  zoom +
  theme_bw() +
  theme(legend.position = "bottom")
```


## Table with extra references

Reading from file:

```{r paged.print = FALSE}
extra_references <- 
  read_sf(filepath,
          layer = "extra_references")
```

Overview of structure:

```{r paged.print = FALSE}
extra_references %>% 
  glimpse()
```

Closer inspection:

```{r}
extra_references
```

The above table can be converted back into a BibTeX bibliography file, using code as shown above.

