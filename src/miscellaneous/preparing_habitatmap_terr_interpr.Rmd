---
title: "Code for clipping watersurfaces out of habitatmap_stdized, as part of generating 'habitatmap_terr_interpr'"
date: '`r paste("Version",lubridate::now())`'
output:
  html_notebook:
    number_sections: yes
    code_folding: show
    includes:
      in_header: ../header.html
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
---

```{r setup, message=FALSE, echo=FALSE}
options(stringsAsFactors = FALSE)
library(raster)
library(tidyverse)
library(stringr)
library(sf)
library(sp)
library(knitr)
library(tmap)
library(n2khab)
opts_chunk$set(
  echo = TRUE,
  dpi = 300
)
```


# Reading basic datasets

Components of `habitatmap_stdized`:

```{r}
habmap_std <- read_habitatmap_stdized()
habmap_std_pol <- habmap_std$habitatmap_polygons
habmap_std_patch <- habmap_std$habitatmap_patches
```

Components of `watersurfaces_hab` (preliminary version at the time of writing):

```{r}
watsurf_pol <- 
    st_read("../../../n2khab_data/20_processed/watersurfaces_hab/watersurfaces_hab.gpkg",
        layer = "watersurfaces_hab_polygons",
        quiet = TRUE)

watsurf_patch <- 
    st_read("../../../n2khab_data/20_processed/watersurfaces_hab/watersurfaces_hab.gpkg",
        layer = "watersurfaces_hab_patches",
        as_tibble = TRUE,
        quiet = TRUE)
```

A little quality control of the layer `watersurfaces_hab`:

```{r eval=FALSE}
tmap_mode('view')
# tmap_mode('plot')
ss <- watsurf_pol %>% 
    count(polygon_id) %>% 
    filter(n > 1)
p <- tm_shape(ss) + 
    tm_borders() +
    tm_fill(col = "n", style = "cat", breaks = 2:5) +
    # tm_polygons(alpha = 0, border.col = "grey") +
    tm_text("polygon_id", size = 0.5)
p
```


```{r}
glimpse(watsurf_patch)
```

**The aim here is to remove all areas from `habitatmap_stdized` which are covered by watersurfaces!**

# Trials to do the 'difference' operation with the sf package

Did't work out due to topological faults in the data sources!

See commit 0f881bb for the details.


# Trials to use sp and rgeos

Same topological errors - not surprising as GEOS is used in all cases.

See commit d6029af for the details.


# Experimenting with the QGIS bridge

On a system with GDAL and GRASS installed, QGIS offers at least:

- access to an OGR algorithm `clipvectorsbypolygon`, which however resulted in an error.

```{r eval=FALSE}
library(RQGIS)
find_algorithms()
find_algorithms("clip", name_only = TRUE)
open_help("gdalogr:clipvectorsbypolygon")
get_usage("gdalogr:clipvectorsbypolygon")
# get_options("gdalogr:clipvectorsbypolygon")
```

```{r eval=FALSE}
habmap_integr_pol <-
    run_qgis("gdalogr:clipvectorsbypolygon",
             INPUT = habmap_std_pol,
             INPUT2 = watsurf_pol,
                 OUTPUT = file.path(tempdir(), "habmap_integr_pol.shp"),
                 load_output = TRUE)
```

- the GRASS algorithm `v.overlay`; however for some reason the transportation of the data is not well done, so error again:

```{r eval=FALSE}
find_algorithms("overlay", name_only = TRUE)
get_usage("grass:v.overlay")
# get_options("grass:v.overlay")
```

```{r eval=FALSE}
habmap_overlap_diff <- 
    run_qgis("grass:v.overlay", 
             ainput = habmap_overlap, 
             binput = watsurf_pol_u, 
             operator = "not",
                 output = "habmap_overlap_diff", # file.path(tempdir(), "habmap_overlap_diff.shp"),
                 load_output = TRUE)
# Error in UseMethod("st_as_sf") : no applicable method for 'st_as_sf' applied to an object of class "c('sfc_MULTIPOLYGON', 'sfc')"
```








