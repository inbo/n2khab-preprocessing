---
title: "Handling the habitatmap"
date: '`r paste("Version",lubridate::now())`'
output:
  html_document:
    number_sections: yes
    code_folding: show
    includes:
      in_header: ../header.html
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
---

```{r setup, message=FALSE, echo=FALSE}
options(stringsAsFactors = FALSE)
library(sf)
library(dplyr)
library(n2khab)
library(knitr)
opts_chunk$set(
  echo = TRUE,
  dpi = 300
)
```


# A few checks of the habitatmap data source


```{r}
filepath <- file.path(fileman_up("n2khab_data"),
                      "10_raw/habitatmap/habitatmap.shp")
habitatmap <- st_read(filepath, layer = "habitatmap")

```

The number of rows is `r nrow(habitatmap)`.

Checksums:
```{r}
filepath %>% 
  n2khab::md5sum() %>% 
  `names<-`("md5sum")
filepath %>% 
  n2khab::sha256sum() %>% 
  `names<-`("sha256sum")
filepath %>% 
  n2khab::xxh64sum() %>% 
  `names<-`("xxh64sum")
```

### A summary of the layer for version 2023

```{r}
habitatmap %>% 
  st_drop_geometry %>% 
  summary
```
Let us look for possible errors.

### Are there `NA` values?

There are plenty of `NA`'s but only in fields where we expect them.

```{r}
sapply(habitatmap, function(x) sum(is.na(x)))
```

### Are there `<Null>` values?

No `<Null>` string.

```{r}
sapply(habitatmap |> st_drop_geometry(), function(x) sum(as.character(x) == '<Null>', na.rm = TRUE))
```

### Are there Zero (0) values?

Yes, but only in PHAB2, PHAB3, PHAB4, PHAB5.

```{r}
sapply(habitatmap |> st_drop_geometry(), function(x) sum(as.character(x) == '0', na.rm = TRUE))
```
### Are TAG codes unique?

Yes. 

```{r}
habitatmap$TAG %>% unique %>% length == nrow(habitatmap)
```

### Is the CRS correct?

Checking the CRS stated in the file as "`r st_crs(habitatmap)$input`": does it actually conform to the EPSG standard (in order to prevent CRS clashes in workflows)?

Does it conform to EPSG:31370?

Apparently NOT?!
Something to do with ESRI? https://github.com/OSGeo/PROJ/issues/1781

```{r}
st_crs(habitatmap) == st_crs(31370)

st_crs(habitatmap)

```{r}
```


```


```{r}
```

# Tidyverse-styled, internationalized column names when using the data source in R

```{r eval = FALSE}
habitatmap %>% colnames %>% cat(sep = "\n")

```

data source variable          data frame variable
----------------------        ---------------------
`TAG`                         `polygon_id` 
`EVAL`                        `eval`
`EENH1`                       `eenh1`
`V1`                          `v1`
`HERK`                        `source`
`INFO`                        `info `
`BWKLABEL`                    `bwk_label`
`HAB1`                        `hab1`
`PHAB1`                       `phab1`
`HERKHAB`                     `source_hab`
`HERKPAH`                     `source_phab`
`OPPERVL`                     `area_m2`

# Other considerations for the R object returned by `read_habitatmap()`

- not uptaking `OIDN`, `UIDN`, `LENGTE`
- added the attribute `fix_geom` to correct the invalid geometries if 


# Used environment

```{r session-info, results = "asis", echo=FALSE}
si <- sessioninfo::session_info()
p <- si$platform %>%
  do.call(what = "c")
if ("sf" %in% si$packages$package) {
  p <- c(p, sf_extSoftVersion())
  names(p)[names(p) == "proj.4"] <- "PROJ"
}
if ("rgrass" %in% si$packages$package) {
  p <- c(p, GRASS = link2GI::findGRASS()[1, "version"])
}
sprintf("- **%s**: %s\n", names(p), p) %>%
  cat(sep = "")
```

```{r results = "asis", echo=FALSE}
si$packages %>%
    as_tibble %>%
    select(package, loadedversion, date, source) %>%
pander::pandoc.table(caption = "Loaded R packages",
                     split.table = Inf)
