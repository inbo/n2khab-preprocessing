---
title: "Handling the watersurfaces data source"
date: "`r paste("Version",lubridate::now())`"
  output:
  html_document:
    toc: yes
    df_print: paged
  html_notebook:
    number_sections: yes
    code_folding: hide
    includes:
      in_header: ../header.html
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
---

```{r setup, message=FALSE, echo=FALSE}
options(stringsAsFactors = FALSE)
# library(sp)
library(sf)
library(raster)
library(tidyverse)
library(n2khab)
# # library(plotly)
# library(rasterVis)
# library(stars)
# library(units)
# library(tmap)
library(knitr)
opts_chunk$set(
  echo = TRUE,
  dpi = 300
)
```

# Exploring the watersurfaces data source

The previous version was 1.0 (10.5281/zenodo.3386859), we want to explore the changes in the most recent version: v 1.1 (10.5281/zenodo.4117543)

```{r}
# manually adapt the path
ws_10 <- read_sf(file.path(fileman_up("n2khab_data"), "10_raw/watersurfaces/versies/v1.0"),
                   stringsAsFactors = TRUE) # n = 86026

ws_11 <- read_sf(file.path(fileman_up("n2khab_data"), "10_raw/watersurfaces/watersurfaces.gpkg"),
                   stringsAsFactors = TRUE)  # n = 88713

```


```{r}
# ws_10 %>% 
#   st_drop_geometry %>% 
#   summary
```
```{r}
ws_11 %>% 
  st_drop_geometry %>% 
  summary
```
Let us look for a few typical errors more systematically in the new version 1.1

### Are there `NA` values?

There are plenty of NA's but only in fields where we expect them.

```{r}
sapply(ws_11, function(x) sum(is.na(x)))

```

### Are there `<Null>` values?

Corrected since v1.0: no  `<Null>` values anymore in `WTRLICHC` or `NAAM` or any of the fields

```{r}
# slow - 25 sec
sapply(ws_11, function(x) sum(as.character(x) == '<Null>', na.rm = TRUE))
```

### Are there Zero (0) values?

Really plenty of zeroes for `HYLAC`

```{r}
# slow - 25 sec
sapply(ws_11, function(x) sum(as.character(x) == '0', na.rm = TRUE))
```

Number of unique values of numeric variable `HYLAC`:

```{r}
ws_11$HYLAC %>% unique %>% length
```

```{r eval=FALSE}
ul <- function(x) x %>% unique %>% length
list(ws_11$HYLAC) %>% 
  lapply(ul)
```

How many `NA` values for numeric variable `HYLAC`?

None!

```{r}
ws_11$HYLAC %>% is.na %>% sum
```
### Are WVLC codes unique?

Yes. It was not the case in version 1.0, but it has been corrected in v1.1

```{r}
ws_11$WVLC %>% unique %>% length
```


### Levels for each factor

We can compare the levels for each factor variable with the information given in 
[Leyssen et al. 2020](https://pureportal.inbo.be/nl/publications/watervlakken-versie-11-polygonenkaart-van-stilstaand-water-in-vla)

I do not check `NAAM` and `GEBIED` since there are many possible options.

**KRWTYPE**: the codes are correct but there are more codes mentioned in the metadata report

```{r}
levels(ws_11$KRWTYPE)
```
**KRWTYPES** (status): the codes are correct

```{r}
levels(ws_11$KRWTYPES)
```
**DIEPKL**: there is an extra code in the dataset ("> 6 m") and the ordering of 
the levels could be more logical

```{r}
levels(ws_11$DIEPKL)
```

(please note "≥" are rendered as "=" in the html output)

**CONNECT**: the codes are correct

```{r}
levels(ws_11$CONNECT)
```
**FUNCTIE**: the code "veedrenk" is not mentioned in the report and there are 
many more codes in the report than in the dataset

```{r}
levels(ws_11$FUNCTIE)
```
## Potential issues:

- (`PEILBEHEER`: mentioned in report Leyssen et al. 2020 but not available in the dataset)
- `HYLAC`: `0` values should be `NA` (empty values, i.e. no code available)
- `KRWTYPE`, `FUNCTIE`: more levels in the metadata report (Leyssen et al. 2020) than in the dataset 
- `DIEPKL`, `FUNCTIE`: extra code in the dataset that is not present in Leyssen et al. 2020

The problem with `HYLAC` = 0 will be taken care of by `read_watersurfaces()`. 
The extra codes will be discussed with the authors of the layers.


## Let's plot the watersurfaces as a map

```{r plot}

# plot watersurfaces v1.1
 p <- ggplot() +
  geom_sf(data = ws_11, aes(), color = "blue")

# Flanders
sf_vl <- read_admin_areas()

p <- p + 
  geom_sf(data = sf_vl, fill = NA)

print(p)

```

<!-- ### Are all the watersurfaces in Flanders? -->

<!-- ```{r streams-in-fl} -->
<!-- in_vl <- st_contains(x = sf_vl, y = ws_11) -->

<!-- not_contained <- ws_11 %>%  -->
<!--   st_drop_geometry() %>%  -->
<!--   mutate(orig_rowname = rownames(.)) %>%  -->
<!--   filter(!rownames(.) %in% in_vl[[1]]) -->

<!-- # 61 watersurfaces -->
<!-- print(not_contained %>% nrow()) -->

<!-- not_contained %>%  -->
<!--   distinct(WVLC, NAAM) %>%  -->
<!--   kable() -->
<!-- ``` -->
<!-- 61 watersurfaces are not 'contained' within the polygon for Flanders (see list above) -->

# Tidyverse-styled, internationalized column names when using the data source in R

```{r eval = FALSE}
ws_11 %>% colnames %>% cat(sep = "\n")
```

data source variable          data frame variable
----------------------        ---------------------
`WVLC`                        `polygon_id` 
`WTRLICHC`                    `wfd_code`
`HYLAC`                       `hyla_code`
`NAAM`                        `name`
`GEBIED`                      `area_name`
`KRWTYPE`                     `wfd_type `
`KRWTYPES`                    `wfd_type_certain`
`DIEPKL`                      `depth_class`
`CONNECT`                     `connectivity`
`FUNCTIE`                     `usage`

**Other considerations for the R object returned by `read_watersurfaces()`**:

- not uptaking `OPPWVL` & `OMTWVL` (area & perimeter are easily calculated etc) -- OK
- converting 0 values in `HYLAC` to `NA` -- OK
- sort by `polygon_id` -- OK
- add translations to long text for `wfd_type ` and `connectivity`  -- OK but not by default
- add translations to long text for  `usage`? -- for a later version (as more codes will be used)

Here are the categories for:

`CONNECT`

- geïsoleerd: niet verbonden met een waterloop 
- permanent: het watervlak staat permanent in verbinding met minstens één
waterloop 
- periodiek: het watervlak staat tijdelijk (door peilbeheer of droogte) in verbinding
met minstens één waterloop

`FUNCTIE`

functie                       toewijzing
----------------------        ---------------------
natuur                        doelstelling natuurbehoud
hengelintensief               intensief hengelen (met infrastructuur, bepoting of gebruikt voor wedstrijdhengelen)
hengelextensief               extensief hengelen (geen infrastructuur, bepoting of wedstrijdhengelen)
jacht                         jagen
tuin/park                     esthetisch (verblijfsrecreatie, tuin- en parkvijvers)
vogel                         waterpartij voor gedomesticeerde watervogels
viskweek                      opkweken van vis
zwemmen                       zwemmen
duiken                        duiken
zachterecreatie               niet gemotoriseerde watersport
motorrecreatie                gemotoriseerde watersport
berging                       waterberging ten behoeve van overstromings- of peilbeheer
opslag                        reservoir voor water (industrie, landbouw, bluswater, waterkracht…)
drinkwater                    drinkwaterwinning
zuivering                     (kleinschalige) waterzuivering, infiltratie
bezinking                     bezinking van proceswater
drinkplaats                   watervoorziening voor vee
geen                          geen specifieke functie

