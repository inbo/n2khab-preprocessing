---
title: "Exploring Watina"
date: '`r paste("Version",lubridate::now())`'
output:
  html_notebook:
    number_sections: yes
    code_folding: show
    includes:
      in_header: ../header.html
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
---

```{r setup, message=FALSE, echo=FALSE}
options(stringsAsFactors = FALSE)
# library(sp)
# library(sf)
# library(raster)
library(tidyverse)
library(stringr)
# library(n2khab)
# library(plotly)
# library(rasterVis)
# library(stars)
library(DBI)
source("../private_code.R") # just loads connection string for Watina DB
library(dbplyr)
library(dbplot)
library(knitr)
opts_chunk$set(
  echo = TRUE,
  dpi = 300
)
```

# Querying the Watina groundwater database and exploring tables

The below explorations are based on code of Ivy Jansen, but use the `DBI` library instead of `RODBC` (`DBI` is standard in RStudio).


```{r}
con <- inborutils::connect_inbo_dbase("W0002_00_Watina")
```


```{r}
dbListTables(con) %>% sort %>%  View("tables")
```


```{r}
dbGetQuery(con, "SELECT * FROM ext.vwDocumentatie") %>% View("docu")
```

The above was the DWH (datawarehouse).
What is in the database itself?

```{r}
con2 <- inborutils::connect_inbo_dbase("D0025_00_Watina")
```

Aha.

## Locations and filters

Listing relevant tables and showing first records:

```{r}
locations <-  tbl(con, "vwDimMeetpunt")
locations %>% glimpse
```

Variables of interest: `MeetpuntWID`, `MeetpuntCode`, `MeetpuntStatusCode`, `MeetpuntTypeCode`, `MeetpuntXCoordinaat`, `MeetpuntYCoordinaat`.


```{r}
# dbplot library provides a few basic graph functions for which the 
# calculations are executed inside the database, and a ggplot object is returned.
locations %>% 
    dbplot_raster(MeetpuntXCoordinaat, 
                  MeetpuntYCoordinaat, resolution = 300) +
    coord_fixed()
```


```{r}
dbGetQuery(con, 'SELECT TOP(6) * FROM DimMeetpunt')
```

```{r}
locations %>% 
  count(MeetpuntTypeCode, MeetpuntType)
```

```{r}
locations %>% 
  distinct(MeetpuntTypeCode) %>% 
  pull(MeetpuntTypeCode) %>% 
  dput
```

```{r}
locations %>% 
  count(MeetpuntStatusCode, MeetpuntStatus)
```

```{r}
locations %>% 
  distinct(MeetpuntStatusCode) %>% 
  pull(MeetpuntStatusCode) %>% 
  dput
```

```{r}
areas <- tbl(con, "vwDimGebied")
areas %>% glimpse()
```

```{r}
locations %>% 
  inner_join(areas) %>% 
  mutate(area_name2 = str_sub(MeetpuntCode, end = 3)) %>% 
  count(area_name2, GebiedCode) %>% 
  filter(area_name2 != GebiedCode) %>% 
  collect %>% 
  nrow
```



```{r}
gwfilters <- tbl(con, "vwDimPeilpunt")
```


```{r}
gwfilters %>% glimpse
```

Variables of interest: `MeetpuntWID`, `PeilpuntWID`, `PeilpuntCode`, `PeilpuntStatusCode`, `PeilbuisLengte`, `ReferentieNiveauMaaiveld`.

```{r}
gwfilters %>% 
  count(PeilpuntStatusCode, PeilpuntStatusNaam)
```


The table `vwDimPeilpunt` will be needed to select the shallow groundwater filters (i.e. with filter base < 3 m below soil surface), and to select the shallowest filter from (remaining) filters duplets.

Let's explore that a little more:

```{r}
gwfilters %>% 
  dbplot_histogram(ReferentieNiveauMaaiveld)
```

```{r}
gwfilters %>% 
  filter(is.na(ReferentieNiveauMaaiveld)) %>% 
  collect %>% 
  nrow
```

```{r}
gwfilters %>% 
  select(1) %>% 
  collect %>% 
  nrow
```


```{r}
gwfilters %>% 
    mutate(filterbase = -(PeilbuisLengte - ReferentieNiveauMaaiveld)) %>% 
    ggplot(aes(x = filterbase)) + 
    geom_histogram(colour = "grey90") +
    scale_y_log10() +
    xlab("filterbase (m below soil surface)")
```

```{r}
gwfilters %>% 
    mutate(filterbase = -(PeilbuisLengte - ReferentieNiveauMaaiveld),
           shallow = filterbase > -3) %>% 
    filter(filterbase > -10) %>% 
    ggplot(aes(x = filterbase, fill = shallow)) +
    geom_histogram(binwidth = 0.5, colour = "grey90") + 
    # scale_y_log10() +
    xlab("filterbase (m below soil surface)")
```

```{r}
gwfilters %>% 
    mutate(filterbase = -(PeilbuisLengte - ReferentieNiveauMaaiveld)) %>% 
    filter(filterbase == -3) %>% 
    select(PeilpuntWID) %>% 
    collect %>% 
    nrow
```

Just including the filterdepths of exactly 3 meters deep would however add 433  filters, so let's include that one as well (it probably has to do with rounding effects):

```{r}
gwfilters %>% 
    mutate(filterbase = -(PeilbuisLengte - ReferentieNiveauMaaiveld),
           shallow = filterbase >= -3) %>% 
    filter(filterbase > -10) %>% 
    ggplot(aes(x = filterbase, fill = shallow)) +
    geom_histogram(binwidth = 0.5, colour = "grey90") + 
    # scale_y_log10() +
    xlab("filterbase (m below soil surface)")
```

```{r}
gwfilters %>% 
    mutate(filterbase = -(PeilbuisLengte - ReferentieNiveauMaaiveld)) %>% 
    filter(filterbase >= -3) %>% 
    select(PeilpuntWID) %>% 
    collect %>% 
    nrow
```


## Groundwater levels: XG3

```{r}
# "SELECT * FROM ssrs_Precalc"
# the following works:
XG3 <- tbl(con, "ssrs_Precalc")
XG3 %>% glimpse()
```

Variables of interest for MNE: `HydroJaar`, `MeetpuntWID`, `GHG_2`, `GLG_2`, `GVG_2`, `MetingTypeWID`.
Optionally (with a switch?) the `_1` versions of the XG3 variables.
`_1`-variables are the absolute groundwater levels, `_2`-variables are the groundwater levels relative to soil surface.

Nr of rows in this table:

```{r}
XG3 %>% collect %>% nrow
```

Positive values will need to be set to zero:

```{r}
XG3 %>% 
    filter(GHG_2 > -2,
           GHG_2 < 1.5) %>% 
    dbplot_histogram(GHG_2)
```


```{r echo=TRUE}
tbl(con, "DimMetingType")
```

Will this table be of use?
May be.
We could replace `MetingTypeWID` in the previous table by a factor `measurement_type`, using the codes from `MetingTypeWID` and translating these (within a function that has a `lang` argument) to a label variable with either Dutch or English (or ...) names by storing those in the `namelist` data source of the R package.


## Chemical data

```{r}
# "SELECT * FROM DimChemVar"
# the following works:
chemvars <- tbl(con, "DimChemVar")
chemvars %>% glimpse()
```

This table provides the chemical variable definitions.

```{r}
# "SELECT * FROM FactChemischeMeting"
# the following works:
chem_measurements <- tbl(con, "FactChemischeMeting")
chem_measurements %>% glimpse
```

This table provides the chemical measurements.
Essential variables are: `MeetpuntWID`, `DatumWID`, `ChemVarWID`, `Meetwaarde`, `MeetwaardeMEQ`, `IsBelowLOQ`, `MetingStatusCode`, `MetingStatus`.

What about this one?

```{r}
chem_measurements <- tbl(con, "vwFactChemischeMeting")
chem_measurements %>% glimpse
```


Missing in both cases: electroneutrality (but see CÃ©cile's [remark](https://docs.google.com/a/inbo.be/document/d/1isa_9HYQcxo8OYi0fKYmLY42GGTNxpev6RgW05WNxE4/edit?disco=AAAACuSS6FU)).

Electroneutrality is in the following table however:

```{r}
tbl(con, "ssrs_StaalEN") %>% 
  glimpse
```

Here we will need `StaalID` and `StaalEN`.



```{r}
dbDisconnect(con)
```


