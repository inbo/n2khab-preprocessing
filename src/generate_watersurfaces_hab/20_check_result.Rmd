# Check results

## The new version v6.1 interim

Based on habitatmap_stdized_2023_v1 and watersurfaces_2024

Checksums:

```{r}
c("xxh64", "md5", "sha256") %>% 
  map_dfr(~tibble(algorithm = ., 
                  checksum = checksum(filepath, .))) %>% 
  kable
```

Read file:

```{r paged.print=FALSE, warning=FALSE}
(pol <- read_sf(filepath, 
                layer = "watersurfaces_hab_polygons"))
```

```{r paged.print=FALSE, warning=FALSE}
(types <- read_sf(filepath, 
                layer = "watersurfaces_hab_types"))
```


- Do all records in the watersurfaces_hab_types table have a corresponding spatial feature in the watersurfaces_hab_polygons layer?

```{r}
check_polygon_id_types <- types %>%
  anti_join(pol, by = "polygon_id")
nrow(check_polygon_id_types) == 0
```

- Do all spatial features in the watersurfaces_hab_polygons layer have a corresponding record in the watersurfaces_hab_types table?

```{r}
check_polygon_id_polygons <- pol %>%
  st_drop_geometry() %>%
  anti_join(types, by = "polygon_id")
nrow(check_polygon_id_polygons) == 0
```

- Is the number of unique IDs in the dataframe the same as the number of polygons in the sf object? 
  
```{r} 
 types %>%  
   distinct(polygon_id) %>%  
   nrow == nrow(pol) 
``` 

- Is the CRS conform EPSG:31370?

```{r} 
 st_crs(pol) == st_crs(31370) 
```

- Are the geometries valid?

```{r}
validities <- st_is_valid(pol)
sum(!validities | is.na(validities)) == 0
```

## Compare with the previous version 

We load the previous version of watersurfaces_hab (version 6 based on watersurfaces_2024 and habitatmap_stdized_2023_v1)


```{r import hmws_v6, paged.print=FALSE, warning=FALSE}

filepath_v6 <- file.path(path,"20_processed/_versions/watersurfaces_hab/watersurfaces_hab_v6/watersurfaces_hab.gpkg")

hashes <-
    tibble(filepath_v6) %>%
    mutate(filename = basename(filepath_v6),
           md5 = map(filepath_v6, function(x) {
                           x %>% md5sum() %>% str_c(collapse = '')
                         }) %>% as.character) %>% 
           mutate(md5_ref = c("4f589b43c6d3d38e06ee3ea81e3d2058"),
           match = md5 == md5_ref) %>%
    select(filename,
           md5,
           md5_ref,
           match)

if (!all.equal(hashes$md5, hashes$md5_ref)) {
    stop(cat("The source map is NOT v6 ! Please check the datasource. "))
}
  
(pol_v6 <- read_sf(filepath_v6, 
                layer = "watersurfaces_hab_polygons"))
(types_v6 <- read_sf(filepath_v6, 
                layer = "watersurfaces_hab_types"))
```

- Are there differences between version v6.1 interim and version v6 and where are they located?

Apparently v6 uses MULTIPOLYGONs while v6.1 interim uses POLYGONs:

```{r}
summary(pol$geom)
summary(pol_v6$geom)
```
So we'd better convert them all to the same type before comparing:

```{r}

pol <- pol %>% st_cast("MULTIPOLYGON")

```


Since v6.1 interim uses a new `polygon_id` (not based on the TAG of the previous 
official versions), the polygons will have different values in `polygon_habitatmap_id`. 
This means we cannot compare the polygons as easily between versions. 
Only `polygon_id_ws` is a field shared by both versions.

First we look at the **differences between polygons sharing the same** `polygon_id_ws`.

The geometries haven't changed but there are differences in the descriptions 
(which is perfectly plausible with a new version of the habitatmap).

```{r compare v6 v6.1 shared id_ws}
# compare polygons with polygon_id_ws in v6.1 interim and v6
check_polygon_id_ws_v6_v61int <- pol %>%
  filter(!is.na(polygon_id_ws)) %>% 
  inner_join(pol_v6 %>%
               mutate(geom_text_v6 = st_as_text(geom)) %>% 
              st_drop_geometry() %>%
              select(polygon_id_ws, description_orig_v6 = description_orig, geom_text_v6), 
            by = c( "polygon_id_ws")) %>%
  mutate(description_orig_update = description_orig != description_orig_v6,
         geom_text_v61int = st_as_text(geom),  
         geom_update = geom_text_v61int != geom_text_v6)

check_polygon_id_ws_v6_v61int %>%
  st_drop_geometry() %>%
  group_by(geom_update, description_orig_update) %>%
  summarise(n_records = n()) %>%
  ungroup() %>%
  kable() %>%
  kable_styling()

```

Let us take a look at the modified descriptions:

```{r}
check_polygon_id_ws_v6_v61int %>%
  st_drop_geometry() %>% 
  filter(description_orig_update == TRUE) %>% 
  select(polygon_id, polygon_id_ws, 
         description_orig_v6, description_orig_v6.1_interim = description_orig) %>% 
  kable() %>%
  kable_styling() %>% 
  scroll_box(height = "400px")
```

The observed differences seem quite plausible (small changes in percentages and types). 

Now let us **compare the other polygons** between versions (that is: the polygons without 
a shared `polygon_id_ws`).

```{r}
# select the polygons without a shared polygon_id_ws
pol_unshared <- pol %>% 
  anti_join(check_polygon_id_ws_v6_v61int %>% st_drop_geometry(),
            by = "polygon_id_ws")
pol_v6_unshared <- pol_v6 %>% 
  anti_join(check_polygon_id_ws_v6_v61int %>% st_drop_geometry(),
            by = "polygon_id_ws")

```

Here are the polygons without a shared `polygon_id_ws` between versions 
(red: v6 and dark red: v6.1 interim), with watersurfaces and the habitatmap 2024 v99 interim for a comparison:

```{r compare v6 v6.1 unshared id_ws}

ws_overlapping <- pol_unshared %>% 
  rbind(pol_v6_unshared) %>% 
  st_filter(watersurfaces, .predicates = st_overlaps) %>% 
  st_transform(4326)

hm_overlapping <- pol_unshared %>% 
  rbind(pol_v6_unshared) %>% 
  st_filter(habmap$habitatmap_polygons, .predicates = st_overlaps) %>% 
  st_transform(4326)

pol_unshared %>%
  st_transform(4326) %>%
  leaflet() %>%
  addTiles() %>%
  addPolygons(group = "v6.1 interim (dark red)",
              color = "darkred", 
              popup = paste0("v6.1 interim<br>id ws: ",
                             pol_unshared$polygon_id_ws, "<br>id hab:",
                             pol_unshared$polygon_id_habitatmap, "<br>",
                             pol_unshared$description_orig)) %>% 
  addPolygons(data = pol_v6_unshared %>%
                st_transform(4326), 
              color = "red", group = "v6 (red)",
              popup = paste0("v6<br>id ws: ",
                             pol_v6_unshared$polygon_id_ws, "<br>id hab:",
                             pol_v6_unshared$polygon_id_habitatmap, "<br>",
                             pol_v6_unshared$description_orig)) %>%
  addPolygons(data = ws_overlapping,
              group = "watersurfaces",) %>%
  addPolygons(data = hm_overlapping,
              color = "grey30",
              group = "habmap 2024 v99 interim (grey)",
              popup = paste0("habmap 2024 v99 interim:<br>",
                             hm_overlapping$description_orig)) %>% 
   addLayersControl(
   overlayGroups = c("v6.1 interim (dark red)", "v6 (red)", 
                     "watersurfaces", "habmap 2024 v99 interim (grey)"),
    options = layersControlOptions(collapsed = FALSE)
  )

```

It is not easy to compare the differences in a systematical way, but I do not see 
problems a the first sight. 
