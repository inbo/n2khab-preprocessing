# Generate a habitatmap of water surfaces

## Data sources

* The processed habitatmap of Flanders

* The water surfaces map of Flanders


```{r read processed habmap}

habmap <- read_habitatmap_stdized(path = "../../data") 

```

```{r read watersurfaces map}

watersurfaces <- st_read(dsn = "../../data/10_raw/watersurfaces",
                  layer = "watersurfaces",
                  crs = 31370)

```

## Habitatmap 2190_a

For habitat sutbtype 2190_a we select all water surfaces within habitat map polygons that contain coastal dune habitat types. In a next step, this selection will have to be manually screened, as some of the larger (artificial) water surfaces within dune habitat polygons might not correspond with the 2190_a subtype.

### Selection of dune habitat polygons

```{r select dune habitat polygons}

habitatmap_patches_21xx <- habmap$habitatmap_patches %>%
  filter((str_sub(type, 1, 2) == "21")) 

habitatmap_polygons_21xx <- habmap$habitatmap_polygons %>%
  filter(polygon_id %in% habitatmap_patches_21xx$polygon_id)

```

## Selection of water surfaces that overlap with dune habitat polygons in habitat map

```{r}

watersurfaces_21xx <- watersurfaces[habitatmap_polygons_21xx,]

```


## Create 2190_a map 

```{r}

intersection_ws_21xx <- watersurfaces_21xx %>%
    st_intersection(habitatmap_polygons_21xx) %>%
    select(polygon_id_ws = WVLC, polygon_id = polygon_id, description_orig)

habitatmap_2190_a_patches <- intersection_ws_21xx %>%
    st_drop_geometry() %>%
    left_join(habitatmap_patches_21xx, by = "polygon_id") %>%
    rename(polygon_id_habitatmap = polygon_id) %>%
    distinct(polygon_id_ws, polygon_id_habitatmap, description_orig) %>%
    mutate(type = "2190_a") %>%
    group_by(polygon_id_ws, type) %>%
    summarise(polygon_id_habitatmap = str_c(polygon_id_habitatmap, collapse = "+"),
           description_orig =  str_c(description_orig, collapse = "+")) %>%
    ungroup() 

description <- habitatmap_2190_a_patches %>%
    distinct(polygon_id_ws, polygon_id_habitatmap, description_orig)

habitatmap_2190_a_polygons <- watersurfaces_21xx %>%
    select(polygon_id_ws = WVLC) %>%
    filter(polygon_id_ws %in% habitatmap_21xx_patches$polygon_id_ws) %>%
    left_join(description, by = "polygon_id_ws") %>%
    mutate(polygon_type = "watersurface map",
           polygon_id = polygon_id_ws) %>%
    select(polygon_id, polygon_id_ws, polygon_id_habitatmap, description_orig, polygon_type)

habitatmap_2190_a_patches <- habitatmap_2190_a_patches %>%
    select(-description_orig) %>%
    mutate(patch_id = 1,
           code_orig = NA,
           certain = TRUE,
           polygon_id = polygon_id_ws) %>%
    select(polygon_id, polygon_id_ws, polygon_id_habitatmap, patch_id, code_orig, certain, type)


```

## Create 31xx map

```{r}
habitatmap_patches_31xx <- habmap$habitatmap_patches %>%
  filter((str_sub(type, 1, 2) == "31")) 

habitatmap_polygons_31xx <- habmap$habitatmap_polygons %>%
  filter(polygon_id %in% habitatmap_patches_31xx$polygon_id)

watersurfaces_31xx <- watersurfaces[habitatmap_polygons_31xx,]
```


### Intersection water surfaces and 31xx habitat

```{r}

intersection_ws_31xx <- watersurfaces_31xx %>%
    st_intersection(habitatmap_polygons_31xx) %>%
    select(polygon_id_ws = WVLC, polygon_id = polygon_id, description_orig)

habitatmap_comb_patches <- intersection_ws_31xx %>%
    st_drop_geometry() %>%
    left_join(habitatmap_patches_31xx, by = "polygon_id") %>%
    rename(polygon_id_habitatmap = polygon_id) %>%
    distinct(polygon_id_ws, polygon_id_habitatmap, description_orig, code_orig, certain, type) %>%
    group_by(polygon_id_ws, code_orig, certain, type) %>%
    summarise(polygon_id_habitatmap = str_c(polygon_id_habitatmap, collapse = "+"),
           description_orig =  str_c(description_orig, collapse = "+")) %>%
    ungroup() %>%
    group_by(polygon_id_ws) %>%
    mutate(patch_id = rank(code_orig)) %>%
    ungroup()

description <- habitatmap_comb_patches %>%
    distinct(polygon_id_ws, polygon_id_habitatmap, description_orig)

habitatmap_comb_polygons <- watersurfaces_31xx %>%
    select(polygon_id_ws = WVLC) %>%
    filter(polygon_id_ws %in% habitatmap_comb_patches$polygon_id_ws) %>%
    left_join(description, by = "polygon_id_ws") %>%
    mutate(polygon_type = "watersurface map")

habitatmap_comb_patches <- habitatmap_comb_patches %>%
    select(-description_orig)

```


### 31xx habitat that does not intersect with water surface map

```{r}

habitatmap_polygons_31xx_no_ws <- habitatmap_polygons_31xx %>%
    filter(!polygon_id %in% intersection_ws_31xx$polygon_id) %>%
    rename(polygon_id_habitatmap = polygon_id, geometry = geom) %>%
    mutate(polygon_id_ws = NA,
           polygon_type = "habitatmap")

habitatmap_patches_31xx_no_ws <- habitatmap_patches_31xx %>%
    filter(!polygon_id %in% intersection_ws_31xx$polygon_id) %>%
    mutate(polygon_id_habitatmap = polygon_id,
           polygon_id_ws = NA) %>%
    select(-phab)

```


### Combine habitatmap polygons and water surface polygons

```{r}

habmap_31xx_patches <- habitatmap_comb_patches %>%
    bind_rows(habitatmap_patches_31xx_no_ws) %>%
    mutate(polygon_id = ifelse(is.na(polygon_id_ws),
                               as.character(polygon_id_habitatmap),
                               as.character(polygon_id_ws))) %>%
    select(polygon_id, polygon_id_ws, polygon_id_habitatmap, patch_id, everything())

habmap_31xx_polygons <- habitatmap_comb_polygons %>%
    rbind(habitatmap_polygons_31xx_no_ws) %>%
    mutate(polygon_id = ifelse(is.na(polygon_id_ws),
                               as.character(polygon_id_habitatmap),
                               as.character(polygon_id_ws))) %>%
    select(polygon_id, polygon_id_ws, polygon_id_habitatmap, everything())
    
```

## Combine 31xx and 2190_a map

```{r}
habmap_ws_patches <- habmap_31xx_patches %>%
    bind_rows(habitatmap_2190_a_patches) 

habmap_ws_polygons <- habmap_31xx_polygons %>%
    rbind(habitatmap_2190_a_polygons) 
```


## Write results into a geopackage

```{r}

st_write(habmap_ws_polygons, "../../data/20_processed/habitatmap_watersurfaces/habitatmap_watersurfaces.gpkg", layer = "habitatmap_watersurfaces_polygons", driver = "GPKG")

con = dbConnect(SQLite(),
                dbname = "../../data/20_processed/habitatmap_watersurfaces/habitatmap_watersurfaces.gpkg")

dbWriteTable(con, "habitatmap_watersurfaces_patches", habmap_ws_patches)

dbDisconnect(con)

```
